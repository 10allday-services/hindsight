
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Using Decoders with Input Plugins Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.2">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-navigator/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="cookbooks.html" />
    
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Hindsight (0.15.3)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../architecture.html">
            
                <a href="../architecture.html">
            
                    
                    Architecture
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../performance.html">
            
                <a href="../performance.html">
            
                    
                    Performance
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="../configuration.html">
            
                <a href="../configuration.html">
            
                    
                    Configuration
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="../hindsight_cli.html">
            
                <a href="../hindsight_cli.html">
            
                    
                    Command Line Version
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="../hindsight_timer_report.html">
            
                <a href="../hindsight_timer_report.html">
            
                    
                    Execution Profiling
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7" >
            
                <a target="_blank" href="http://mozilla-services.github.io/lua_sandbox/heka/index.html">
            
                    
                    Heka Sandbox Documentation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8" >
            
                <a target="_blank" href="http://mozilla-services.github.io/lua_sandbox_extensions/index.html">
            
                    
                    Sandbox Extensions Documentation
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Tutorials</li>
        
        
    
        <li class="chapter active" data-level="2.1" data-path="using_decoders_with_input_plugins.html">
            
                <a href="using_decoders_with_input_plugins.html">
            
                    
                    Using Decoders with Input Plugins
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2" data-path="cookbooks.html">
            
                <a href="cookbooks.html">
            
                    
                    Common Configuration Cookbooks
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Using Decoders with Input Plugins</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="Using_Decoders_with_Input_Plugins">Using Decoders with Input Plugins</h1>
<p>This guide walks through how input plugins and decoders are used in the context
of ingesting syslogs. Each section starts with a description followed by a
configuration, input file and the resulting output. The configurations are
evolved to demonstrate the available functionality.</p>
<p>For all of the <a href="https://github.com/mozilla-services/lua_sandbox_extensions/syslog/tests/integration/tutorial" target="_blank">examples</a>
in this guide the
<a href="https://mozilla-services.github.io/lua_sandbox_extensions/heka/sandboxes/heka/input/file.html" target="_blank">file</a>
input is used. In a real world environment one would most likely use the
<a href="https://mozilla-services.github.io/lua_sandbox_extensions/lfs/sandboxes/heka/input/tail.html" target="_blank">tail</a>,
<a href="https://mozilla-services.github.io/lua_sandbox_extensions/socket/sandboxes/heka/input/udp.html" target="_blank">udp</a>
or
<a href="https://mozilla-services.github.io/lua_sandbox_extensions/socket/sandboxes/heka/input/tcp.html" target="_blank">tcp</a>
input plugins. They can be swapped in at any time as the <a href="https://mozilla-services.github.io/lua_sandbox_extensions/syslog/io_modules/decoders/syslog.html" target="_blank">syslog
decoder</a>
configurations discussed here are independent from the input plugin being used.</p>
<h2 id="Definition_of_Terms">1. Definition of Terms</h2>
<ul>
<li><a href="http://mozilla-services.github.io/lua_sandbox/heka/input.html" target="_blank">Input Plugin</a> -
A piece of Lua code that loads data into Hindsight</li>
<li>Decoders/Sub-decoders - Zero or more stages during the input process where the
raw data is transformed into a more useful form</li>
<li><a href="https://mozilla-services.github.io/lua_sandbox_extensions/#Decoder_API_Convention" target="_blank">Decoder Module</a> -
A Lua module (installed piece of code) used by input plugins to transform the
raw input data</li>
<li>Grammar Module - A Lua module used by input plugins to transform the raw input
data using only an <a href="http://www.inf.puc-rio.br/~roberto/lpeg/" target="_blank">LPeg</a> grammar</li>
<li>printf Module - A Lua module with pre-defined
<a href="https://mozilla-services.github.io/lua_sandbox_extensions/lpeg/modules/lpeg/printf.html#build_grammar" target="_blank">printf parsers</a>
in an exported
<a href="https://mozilla-services.github.io/lua_sandbox_extensions/lpeg/modules/lpeg/printf.html#load_messages" target="_blank">printf_messsages</a>
variable</li>
<li>Ad-hoc Parser - A data parser defined in the configuration instead of a
decoder/grammar module</li>
</ul>
<hr>
<h2 id="Basic_Syslog_Decoder_Module">2. Basic Syslog Decoder Module</h2>
<p>This is an example of a basic syslog decoder that extracts the header
information (timestamp, hostname, pid, programname) and the message string. The
only thing required to configure the basic syslog decoder is the template
configuration specified in the
<a href="http://rsyslog-5-8-6-doc.neocities.org/rsyslog_conf_templates.html" target="_blank">rsyslog.conf</a>
file. The template below is the RSYSLOG_TraditionalFileFormat without the new
line at the end since that is consumed by the file input. The Uuid (type 4
random) and Logger (input plugin name) are added to the output by Hindsight.</p>
<h3 id="Configuration">2.1. Configuration</h3>
<pre><code class="lang-lua">filename = <span class="hljs-string">&quot;file.lua&quot;</span>
input_filename = <span class="hljs-string">&quot;syslog.log&quot;</span>
send_decode_failures = <span class="hljs-keyword">true</span>
decoder_module = <span class="hljs-string">&quot;decoders.syslog&quot;</span>

decoders_syslog = {
  template = <span class="hljs-string">&quot;%TIMESTAMP% %HOSTNAME% %syslogtag%%msg:::sp-if-no-1st-sp%%msg:::drop-last-lf%&quot;</span>,
}
</code></pre>
<h3 id="Input">2.2. Input</h3>
<pre><code>Feb 13 14:25:19 ubuntu sshd[7192]: Accepted publickey for foobar from 216.160.83.56 port 4242 ssh2
</code></pre><h3 id="Output">2.3. Output</h3>
<pre><code class="lang-rst">:Uuid: 0c1e9271-6b7c-451e-aa05-63cdaf14cf10
:Timestamp: 2018-02-13T14:25:19.000000000Z
:Type: &lt;nil&gt;
:Logger: input.syslog
:Severity: 7
:Payload: Accepted publickey for foobar from 216.160.83.56 port 4242 ssh2
:EnvVersion: &lt;nil&gt;
:Pid: 7192
:Hostname: ubuntu
:Fields:
    | name: programname type: 0 representation: &lt;nil&gt; value: sshd
</code></pre>
<hr>
<h2 id="Ad-hoc_printf_Decoder">3. Ad-hoc printf Decoder</h2>
<p>This is an example of a syslog decoder using an ad-hoc printf parser.  The key
in the sub_decoders hash is the programname from the syslog and its value is an
array containing a
<a href="https://mozilla-services.github.io/lua_sandbox_extensions/lpeg/modules/lpeg/printf.html#build_grammar" target="_blank">printf grammar specification</a>
with a nil transformation table.</p>
<h3 id="Configuration">3.1. Configuration</h3>
<pre><code class="lang-lua">filename = <span class="hljs-string">&quot;file.lua&quot;</span>
input_filename = <span class="hljs-string">&quot;adhoc.log&quot;</span>
send_decode_failures = <span class="hljs-keyword">true</span>
decoder_module = <span class="hljs-string">&quot;decoders.syslog&quot;</span>

decoders_syslog = {
  template = <span class="hljs-string">&quot;%TIMESTAMP% %HOSTNAME% %syslogtag%%msg:::sp-if-no-1st-sp%%msg:::drop-last-lf%&quot;</span>,

  sub_decoders = {
    foo = {
      { {<span class="hljs-string">&quot;%s:%lu: invalid line&quot;</span>, <span class="hljs-string">&quot;path&quot;</span>, <span class="hljs-string">&quot;linenum&quot;</span>}, <span class="hljs-keyword">nil</span>},
    },
  },
}
</code></pre>
<h3 id="Input">3.2. Input</h3>
<pre><code>Jan 23 08:50:03 ubuntu foo[1234]: /tmp/input.tsv:23: invalid line
</code></pre><h3 id="Output">3.3. Output</h3>
<pre><code class="lang-rst">:Uuid: ff56099b-51d0-4ca5-af70-7509eaa6450a
:Timestamp: 2018-01-23T08:50:03.000000000Z
:Type: &lt;nil&gt;
:Logger: input.adhoc
:Severity: 7
:Payload: /tmp/input.tsv:23: invalid line
:EnvVersion: &lt;nil&gt;
:Pid: 1234
:Hostname: ubuntu
:Fields:
    | name: linenum type: 3 representation: &lt;nil&gt; value: 23
    | name: path type: 0 representation: &lt;nil&gt; value: /tmp/input.tsv
    | name: programname type: 0 representation: &lt;nil&gt; value: foo
</code></pre>
<hr>
<h2 id="Pre-defined_printf_Module_Decoder">4. Pre-defined printf Module Decoder</h2>
<p>This is an example of a syslog decoder using a printf parser library. The value
in the printf_messages array is the name of a module exporting another
<a href="https://mozilla-services.github.io/lua_sandbox_extensions/lpeg/modules/lpeg/printf.html#load_messages" target="_blank">printf_messsage</a>
array that is imported for use here. The key in the sub_decoders hash is the
programname from the syslog and its value is an array containing a sample
message that the user would like parsed.</p>
<h3 id="Configuration">4.1. Configuration</h3>
<pre><code class="lang-lua">filename = <span class="hljs-string">&quot;file.lua&quot;</span>
input_filename = <span class="hljs-string">&quot;syslog.log&quot;</span>
send_decode_failures = <span class="hljs-keyword">true</span>
decoder_module = <span class="hljs-string">&quot;decoders.syslog&quot;</span>

decoders_syslog = {
  template = <span class="hljs-string">&quot;%TIMESTAMP% %HOSTNAME% %syslogtag%%msg:::sp-if-no-1st-sp%%msg:::drop-last-lf%&quot;</span>,

  printf_messages = {
   <span class="hljs-string">&quot;lpeg.openssh_portable&quot;</span>,
  },

  sub_decoders = {
    sshd = {
      <span class="hljs-string">&quot;Accepted publickey for foobar from 192.168.1.1 port 4567 ssh2&quot;</span>,
    },
  },
}
</code></pre>
<h3 id="Input">4.2. Input</h3>
<pre><code>Feb 13 14:25:19 ubuntu sshd[7192]: Accepted publickey for foobar from 216.160.83.56 port 4242 ssh2
</code></pre><h3 id="Output">4.3. Output</h3>
<pre><code class="lang-rst">:Uuid: 3bde3689-26a7-484f-a893-a7d6718be4c6
:Timestamp: 2018-02-13T14:25:19.000000000Z
:Type: &lt;nil&gt;
:Logger: input.printf
:Severity: 7
:Payload: Accepted publickey for foobar from 216.160.83.56 port 4242 ssh2
:EnvVersion: &lt;nil&gt;
:Pid: 7192
:Hostname: ubuntu
:Fields:
    | name: ssh_remote_port type: 3 representation: &lt;nil&gt; value: 4242
    | name: method type: 0 representation: &lt;nil&gt; value: publickey
    | name: user type: 0 representation: &lt;nil&gt; value: foobar
    | name: ssh_remote_ipaddr type: 0 representation: ipv4 value: 216.160.83.56
    | name: programname type: 0 representation: &lt;nil&gt; value: sshd
    | name: extra type: 0 representation: &lt;nil&gt; value:
    | name: authmsg type: 0 representation: &lt;nil&gt; value: Accepted
</code></pre>
<hr>
<h2 id="Pre-defined_printf_Module_Decoder_with_Transformation">5. Pre-defined printf Module Decoder with Transformation</h2>
<p>This is an example of a syslog decoder using a printf parser library. The value
in the printf_messages array is the name of a module exporting another
<a href="https://mozilla-services.github.io/lua_sandbox_extensions/lpeg/modules/lpeg/printf.html#load_messages" target="_blank">printf_messsage</a>
array that is imported for use here. The key in the sub_decoders hash is the
programname from the syslog and its value is an array containing a sample
message that the user would like parsed and a transformation table. The
transformation table is keyed by the field name to transform and the value is
the transformation funtion to apply. The
<a href="https://mozilla-services.github.io/lua_sandbox_extensions/maxminddb/io_modules/maxminddb/heka.html" target="_blank">maxminddb_heka</a>
table is the configuration to control the transformation.</p>
<h3 id="Configuration">5.1. Configuration</h3>
<pre><code class="lang-lua">filename = <span class="hljs-string">&quot;file.lua&quot;</span>
input_filename = <span class="hljs-string">&quot;syslog.log&quot;</span>
send_decode_failures = <span class="hljs-keyword">true</span>
decoder_module = <span class="hljs-string">&quot;decoders.syslog&quot;</span>

decoders_syslog = {
  template = <span class="hljs-string">&quot;%TIMESTAMP% %HOSTNAME% %syslogtag%%msg:::sp-if-no-1st-sp%%msg:::drop-last-lf%&quot;</span>,

  printf_messages = {
   <span class="hljs-string">&quot;lpeg.openssh_portable&quot;</span>,
  },

  sub_decoders = {
    sshd = {
      {<span class="hljs-string">&quot;Accepted publickey for foobar from 10.11.12.13 port 4242 ssh2&quot;</span>, {ssh_remote_ipaddr = <span class="hljs-string">&quot;maxminddb.heka#add_geoip&quot;</span>}},
    },
  },
}

maxminddb_heka = {
    databases = {
        [<span class="hljs-string">&quot;GeoIP2-City.mmdb&quot;</span>] = {
            _city = {<span class="hljs-string">&quot;city&quot;</span>, <span class="hljs-string">&quot;names&quot;</span>, <span class="hljs-string">&quot;en&quot;</span>},
            _country = {<span class="hljs-string">&quot;country&quot;</span>, <span class="hljs-string">&quot;iso_code&quot;</span>}
        },
    },
}
</code></pre>
<h3 id="Input">5.2. Input</h3>
<pre><code>Feb 13 14:25:19 ubuntu sshd[7192]: Accepted publickey for foobar from 216.160.83.56 port 4242 ssh2
</code></pre><h3 id="Output">5.3. Output</h3>
<pre><code class="lang-rst">:Uuid: 5018c7e5-e51d-447f-aa84-a2f3a2d9ad11
:Timestamp: 2018-02-13T14:25:19.000000000Z
:Type: &lt;nil&gt;
:Logger: input.printf_transform
:Severity: 7
:Payload: Accepted publickey for foobar from 216.160.83.56 port 4242 ssh2
:EnvVersion: &lt;nil&gt;
:Pid: 7192
:Hostname: ubuntu
:Fields:
    | name: ssh_remote_port type: 3 representation: &lt;nil&gt; value: 4242
    | name: method type: 0 representation: &lt;nil&gt; value: publickey
    | name: user type: 0 representation: &lt;nil&gt; value: foobar
    | name: extra type: 0 representation: &lt;nil&gt; value:
    | name: authmsg type: 0 representation: &lt;nil&gt; value: Accepted
    | name: ssh_remote_ipaddr_city type: 0 representation: &lt;nil&gt; value: Milton
    | name: ssh_remote_ipaddr_country type: 0 representation: &lt;nil&gt; value: US
    | name: programname type: 0 representation: &lt;nil&gt; value: sshd
    | name: ssh_remote_ipaddr type: 0 representation: ipv4 value: 216.160.83.56
</code></pre>
<hr>
<h2 id="Lua_Grammar_Module_Decoder">6. Lua Grammar Module Decoder</h2>
<p>This is an example of a syslog decoder using a grammar module. The key in the
sub_decoders hash is the programname from the syslog and its value is the module
name and optional grammar name reference to apply to the matching messages.</p>
<h3 id="Configuration">6.1. Configuration</h3>
<pre><code class="lang-lua">filename = <span class="hljs-string">&quot;file.lua&quot;</span>
input_filename = <span class="hljs-string">&quot;grammar_module.log&quot;</span>
send_decode_failures = <span class="hljs-keyword">true</span>
decoder_module = <span class="hljs-string">&quot;decoders.syslog&quot;</span>

decoders_syslog = {
  template = <span class="hljs-string">&quot;%TIMESTAMP% %HOSTNAME% %syslogtag%%msg:::sp-if-no-1st-sp%%msg:::drop-last-lf%&quot;</span>,

  sub_decoders = {
    someapp = <span class="hljs-string">&quot;lpeg.logfmt&quot;</span>, <span class="hljs-comment">-- shorthand for &quot;lpeg.logfmt#grammar&quot;</span>
  },
}
</code></pre>
<h3 id="Input">6.2. Input</h3>
<pre><code>Feb 14 19:20:21 ubuntu someapp[3453]: foo=bar a=14 baz=&quot;hello kitty&quot; cool%story=bro f %^asdf ip=216.160.83.56
</code></pre><h3 id="Output">6.3. Output</h3>
<pre><code class="lang-rst">Uuid: 3cafda9a-261f-48b5-a288-cc6c0783ba3e
:Timestamp: 2018-02-14T19:20:21.000000000Z
:Type: &lt;nil&gt;
:Logger: input.grammar_module
:Severity: 7
:Payload: &lt;nil&gt;
:EnvVersion: &lt;nil&gt;
:Pid: 3453
:Hostname: ubuntu
:Fields:
    | name: a type: 0 representation: &lt;nil&gt; value: 14
    | name: foo type: 0 representation: &lt;nil&gt; value: bar
    | name: cool%story type: 0 representation: &lt;nil&gt; value: bro
    | name: baz type: 0 representation: &lt;nil&gt; value: hello kitty
    | name: %^asdf type: 4 representation: &lt;nil&gt; value: true
    | name: programname type: 0 representation: &lt;nil&gt; value: someapp
    | name: f type: 4 representation: &lt;nil&gt; value: true
    | name: ip type: 0 representation: &lt;nil&gt; value: 216.160.83.56
</code></pre>
<hr>
<h2 id="Lua_Grammar_Module_Decoder_with_Transformation">7. Lua Grammar Module Decoder with Transformation</h2>
<p>This is an example of a syslog decoder using a grammar module. The key in the
sub_decoders hash is the programname from the syslog and its value an array with
a grammar module entry and a transformation table.</p>
<h3 id="Configuration">7.1. Configuration</h3>
<pre><code class="lang-lua">filename = <span class="hljs-string">&quot;file.lua&quot;</span>
input_filename = <span class="hljs-string">&quot;grammar_module.log&quot;</span>
send_decode_failures = <span class="hljs-keyword">true</span>
decoder_module = <span class="hljs-string">&quot;decoders.syslog&quot;</span>

decoders_syslog = {
  template = <span class="hljs-string">&quot;%TIMESTAMP% %HOSTNAME% %syslogtag%%msg:::sp-if-no-1st-sp%%msg:::drop-last-lf%&quot;</span>,

  sub_decoders = {
    someapp = {
    { {<span class="hljs-string">&quot;lpeg.logfmt&quot;</span>}, {ip = <span class="hljs-string">&quot;maxminddb.heka#add_geoip&quot;</span>}},
    },
  },
}

maxminddb_heka = {
  databases = {
    [<span class="hljs-string">&quot;GeoIP2-City.mmdb&quot;</span>] = {
        _city = {<span class="hljs-string">&quot;city&quot;</span>, <span class="hljs-string">&quot;names&quot;</span>, <span class="hljs-string">&quot;en&quot;</span>},
        _country = {<span class="hljs-string">&quot;country&quot;</span>, <span class="hljs-string">&quot;iso_code&quot;</span>}
    },
  }
}
</code></pre>
<h3 id="Input">7.2. Input</h3>
<pre><code>Feb 14 19:20:21 ubuntu someapp[3453]: foo=bar a=14 baz=&quot;hello kitty&quot; cool%story=bro f %^asdf ip=216.160.83.56
</code></pre><h3 id="Output">7.3. Output</h3>
<pre><code class="lang-rst">:Uuid: eade849f-e90f-4cc7-a817-265545d4e522
:Timestamp: 2018-02-14T19:20:21.000000000Z
:Type: &lt;nil&gt;
:Logger: input.grammar_transform
:Severity: 7
:Payload: foo=bar a=14 baz=&quot;hello kitty&quot; cool%story=bro f %^asdf ip=216.160.83.56
:EnvVersion: &lt;nil&gt;
:Pid: 3453
:Hostname: ubuntu
:Fields:
    | name: a type: 0 representation: &lt;nil&gt; value: 14
    | name: baz type: 0 representation: &lt;nil&gt; value: hello kitty
    | name: ip type: 0 representation: &lt;nil&gt; value: 216.160.83.56
    | name: f type: 4 representation: &lt;nil&gt; value: true
    | name: ip_country type: 0 representation: &lt;nil&gt; value: US
    | name: ip_city type: 0 representation: &lt;nil&gt; value: Milton
    | name: %^asdf type: 4 representation: &lt;nil&gt; value: true
    | name: programname type: 0 representation: &lt;nil&gt; value: someapp
    | name: cool%story type: 0 representation: &lt;nil&gt; value: bro
    | name: foo type: 0 representation: &lt;nil&gt; value: bar
</code></pre>
<hr>
<h2 id="Lua_Grammar_Module_Decoder_with_Match_Arguments">8. Lua Grammar Module Decoder with Match Arguments</h2>
<p>This is an example of a syslog decoder using a grammar module that takes
additional match arguments. The key in the sub_decoders hash is the programname
from the syslog and its value an array with a grammar module entry and nil
transformation table.</p>
<h3 id="Configuration">8.1. Configuration</h3>
<pre><code class="lang-lua">filename = <span class="hljs-string">&quot;file.lua&quot;</span>
input_filename = <span class="hljs-string">&quot;grammar_module.log&quot;</span>
send_decode_failures = <span class="hljs-keyword">true</span>
decoder_module = <span class="hljs-string">&quot;decoders.syslog&quot;</span>

decoders_syslog = {
  template = <span class="hljs-string">&quot;%TIMESTAMP% %HOSTNAME% %syslogtag%%msg:::sp-if-no-1st-sp%%msg:::drop-last-lf%&quot;</span>,

  sub_decoders = {
    someapp = {
        { {<span class="hljs-string">&quot;syslog_docs#demo&quot;</span>, <span class="hljs-string">&quot;www.example.com&quot;</span>}, <span class="hljs-keyword">nil</span>},
    },
  },
}
</code></pre>
<h3 id="Input">8.2. Input</h3>
<pre><code>Feb 14 19:20:21 ubuntu someapp[3453]: foo=bar a=14 baz=&quot;hello kitty&quot; cool%story=bro f %^asdf ip=216.160.83.56
</code></pre><h3 id="Output">8.3. Output</h3>
<pre><code class="lang-rst">:Uuid: 0cde3ec6-b894-498e-aad6-abf3e4059342
:Timestamp: 2018-02-14T19:20:21.000000000Z
:Type: &lt;nil&gt;
:Logger: input.grammar_args
:Severity: 7
:Payload: foo=bar a=14 baz=&quot;hello kitty&quot; cool%story=bro f %^asdf ip=216.160.83.56
:EnvVersion: &lt;nil&gt;
:Pid: 3453
:Hostname: ubuntu
:Fields:
    | name: programname type: 0 representation: &lt;nil&gt; value: someapp
    | name: real_hostname type: 0 representation: &lt;nil&gt; value: www.example.com
</code></pre>
<hr>
<h2 id="Lua_Grammar_Builder_Module_Decoder">9. Lua Grammar Builder Module Decoder</h2>
<p>This is an example of a syslog decoder using a grammar module that dynamically
builds the needed grammar. The key in the sub_decoders hash is the programname
from the syslog and its value is an array containing a
<a href="https://mozilla-services.github.io/lua_sandbox_extensions/lpeg/modules/lpeg/common_log_format.html#build_nginx_grammar" target="_blank">grammar building function</a>
and its required argument, the log_format configuration string. The
transformation table is not used in this example.</p>
<h3 id="Configuration">9.1. Configuration</h3>
<pre><code class="lang-lua">filename = <span class="hljs-string">&quot;file.lua&quot;</span>
input_filename = <span class="hljs-string">&quot;decoder_module.log&quot;</span>
send_decode_failures = <span class="hljs-keyword">true</span>
decoder_module = <span class="hljs-string">&quot;decoders.syslog&quot;</span>

log_format = <span class="hljs-string">&apos;$remote_addr - $remote_user [$time_local] &quot;$request&quot; $status $body_bytes_sent &quot;$http_referer&quot; &quot;$http_user_agent&quot;&apos;</span>

decoders_syslog = {
  template = <span class="hljs-string">&quot;%TIMESTAMP% %HOSTNAME% %syslogtag%%msg:::sp-if-no-1st-sp%%msg:::drop-last-lf%&quot;</span>,

  sub_decoders = {
    nginx  = {
        { {<span class="hljs-string">&quot;lpeg.common_log_format#build_nginx_grammar&quot;</span>, log_format}, <span class="hljs-keyword">nil</span>},
    },
  },
}
</code></pre>
<h3 id="Input">9.2. Input</h3>
<pre><code>Jan 23 08:50:02 ubuntu nginx[1234]: 127.0.0.1 - - [10/Feb/2014:08:46:41 -0800] &quot;GET / HTTP/1.1&quot; 304 0 &quot;-&quot; &quot;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:26.0) Gecko/20100101 Firefox/26.0&quot;
</code></pre><h3 id="Output">9.3. Output</h3>
<pre><code class="lang-rst">:Uuid: 4d2347c9-26b6-4c7d-a703-edbf9335ecb8
:Timestamp: 2018-01-23T08:50:02.000000000Z
:Type: &lt;nil&gt;
:Logger: input.function
:Severity: 7
:Payload: 127.0.0.1 - - [10/Feb/2014:08:46:41 -0800] &quot;GET / HTTP/1.1&quot; 304 0 &quot;-&quot; &quot;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:26.0) Gecko/20100101 Firefox/26.0&quot;
:EnvVersion: &lt;nil&gt;
:Pid: 1234
:Hostname: ubuntu
:Fields:
    | name: remote_user type: 0 representation: &lt;nil&gt; value: -
    | name: http_user_agent type: 0 representation: &lt;nil&gt; value: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:26.0) Gecko/20100101 Firefox/26.0
    | name: body_bytes_sent type: 3 representation: B value: 0
    | name: remote_addr type: 0 representation: ipv4 value: 127.0.0.1
    | name: time type: 3 representation: &lt;nil&gt; value: 1.392050801e+18
    | name: request type: 0 representation: &lt;nil&gt; value: GET / HTTP/1.1
    | name: programname type: 0 representation: &lt;nil&gt; value: nginx
    | name: http_referer type: 0 representation: &lt;nil&gt; value: -
    | name: status type: 3 representation: &lt;nil&gt; value: 304
</code></pre>
<hr>
<h2 id="Lua_Decoder_Module">10. Lua Decoder Module</h2>
<p>This is an example of a syslog decoder using a decoder module. The key in the
sub_decoders hash is the programname from the syslog and its value is the module
name to apply to the matching messages. The
<a href="https://mozilla-services.github.io/lua_sandbox_extensions/lpeg/io_modules/decoders/nginx/access.html" target="_blank">decoders_nginx_access</a>
table is the configuration information for the specified decoder.  In this case
it is the log_format configuration value from the nginx.conf that produced this
syslog entry.</p>
<h3 id="Configuration">10.1. Configuration</h3>
<pre><code class="lang-lua">filename = <span class="hljs-string">&quot;file.lua&quot;</span>
input_filename = <span class="hljs-string">&quot;decoder_module.log&quot;</span>
send_decode_failures = <span class="hljs-keyword">true</span>
decoder_module = <span class="hljs-string">&quot;decoders.syslog&quot;</span>

decoders_syslog = {
  template = <span class="hljs-string">&quot;%TIMESTAMP% %HOSTNAME% %syslogtag%%msg:::sp-if-no-1st-sp%%msg:::drop-last-lf%&quot;</span>,

  sub_decoders = {
    nginx  = <span class="hljs-string">&quot;decoders.nginx.access&quot;</span>,
  },
}

decoders_nginx_access = {
  log_format = <span class="hljs-string">&apos;$remote_addr - $remote_user [$time_local] &quot;$request&quot; $status $body_bytes_sent &quot;$http_referer&quot; &quot;$http_user_agent&quot;&apos;</span>
}
</code></pre>
<h3 id="Input">10.2. Input</h3>
<pre><code>Jan 23 08:50:02 ubuntu nginx[1234]: 127.0.0.1 - - [10/Feb/2014:08:46:41 -0800] &quot;GET / HTTP/1.1&quot; 304 0 &quot;-&quot; &quot;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:26.0) Gecko/20100101 Firefox/26.0&quot;
</code></pre><h3 id="Output">10.3. Output</h3>
<pre><code class="lang-rst">:Uuid: 544eef18-d932-4928-a927-3059e95d8d33
:Timestamp: 2014-02-10T16:46:41.000000000Z
:Type: &lt;nil&gt;
:Logger: input.decoder_module
:Severity: 7
:Payload: &lt;nil&gt;
:EnvVersion: &lt;nil&gt;
:Pid: 1234
:Hostname: ubuntu
:Fields:
    | name: body_bytes_sent type: 3 representation: B value: 0
    | name: remote_addr type: 0 representation: ipv4 value: 127.0.0.1
    | name: http_referer type: 0 representation: &lt;nil&gt; value: -
    | name: status type: 3 representation: &lt;nil&gt; value: 304
    | name: request type: 0 representation: &lt;nil&gt; value: GET / HTTP/1.1
    | name: programname type: 0 representation: &lt;nil&gt; value: nginx
    | name: remote_user type: 0 representation: &lt;nil&gt; value: -
    | name: http_user_agent type: 0 representation: &lt;nil&gt; value: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:26.0) Gecko/20100101 Firefox/26.0
</code></pre>
<div id="anchors-navbar"><i class="fa fa-anchor"></i><ul><p><a href="#Using_Decoders_with_Input_Plugins">Using Decoders with Input Plugins</a></p><li><a href="#Definition_of_Terms">1. Definition of Terms</a></li><li><a href="#Basic_Syslog_Decoder_Module">2. Basic Syslog Decoder Module</a></li><ul><li><a href="#Configuration">2.1. Configuration</a></li><li><a href="#Input">2.2. Input</a></li><li><a href="#Output">2.3. Output</a></li></ul><li><a href="#Ad-hoc_printf_Decoder">3. Ad-hoc printf Decoder</a></li><ul><li><a href="#Configuration">3.1. Configuration</a></li><li><a href="#Input">3.2. Input</a></li><li><a href="#Output">3.3. Output</a></li></ul><li><a href="#Pre-defined_printf_Module_Decoder">4. Pre-defined printf Module Decoder</a></li><ul><li><a href="#Configuration">4.1. Configuration</a></li><li><a href="#Input">4.2. Input</a></li><li><a href="#Output">4.3. Output</a></li></ul><li><a href="#Pre-defined_printf_Module_Decoder_with_Transformation">5. Pre-defined printf Module Decoder with Transformation</a></li><ul><li><a href="#Configuration">5.1. Configuration</a></li><li><a href="#Input">5.2. Input</a></li><li><a href="#Output">5.3. Output</a></li></ul><li><a href="#Lua_Grammar_Module_Decoder">6. Lua Grammar Module Decoder</a></li><ul><li><a href="#Configuration">6.1. Configuration</a></li><li><a href="#Input">6.2. Input</a></li><li><a href="#Output">6.3. Output</a></li></ul><li><a href="#Lua_Grammar_Module_Decoder_with_Transformation">7. Lua Grammar Module Decoder with Transformation</a></li><ul><li><a href="#Configuration">7.1. Configuration</a></li><li><a href="#Input">7.2. Input</a></li><li><a href="#Output">7.3. Output</a></li></ul><li><a href="#Lua_Grammar_Module_Decoder_with_Match_Arguments">8. Lua Grammar Module Decoder with Match Arguments</a></li><ul><li><a href="#Configuration">8.1. Configuration</a></li><li><a href="#Input">8.2. Input</a></li><li><a href="#Output">8.3. Output</a></li></ul><li><a href="#Lua_Grammar_Builder_Module_Decoder">9. Lua Grammar Builder Module Decoder</a></li><ul><li><a href="#Configuration">9.1. Configuration</a></li><li><a href="#Input">9.2. Input</a></li><li><a href="#Output">9.3. Output</a></li></ul><li><a href="#Lua_Decoder_Module">10. Lua Decoder Module</a></li><ul><li><a href="#Configuration">10.1. Configuration</a></li><li><a href="#Input">10.2. Input</a></li><li><a href="#Output">10.3. Output</a></li></ul></ul></div><a href="#Definition_of_Terms" id="goTop"><i class="fa fa-arrow-up"></i></a>
                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                
                <a href="cookbooks.html" class="navigation navigation-next navigation-unique" aria-label="Next page: Common Configuration Cookbooks">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Using Decoders with Input Plugins","level":"2.1","depth":1,"next":{"title":"Common Configuration Cookbooks","level":"2.2","depth":1,"path":"tutorials/cookbooks.md","ref":"tutorials/cookbooks.md","articles":[]},"previous":{"title":"Sandbox Extensions Documentation","level":"1.8","depth":1,"url":"http://mozilla-services.github.io/lua_sandbox_extensions/index.html","ref":"http://mozilla-services.github.io/lua_sandbox_extensions/index.html","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":["collapsible-menu","navigator"],"pluginsConfig":{"collapsible-menu":{},"navigator":{},"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"tutorials/using_decoders_with_input_plugins.md","mtime":"2018-04-17T14:59:24.115Z","type":"markdown"},"gitbook":{"version":"3.2.2","time":"2018-09-10T20:13:49.182Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-collapsible-menu/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

